<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Menu Sawadika : specialites thai, chinoises et japonaises." />
    <title>Menu | Sawadika</title>
    <link rel="icon" href="./favicon.ico" sizes="any" />
    <link rel="icon" type="image/png" href="./favicon.png" />
    <link rel="stylesheet" href="./styles.css" />
    <script src="./data.js"></script>
    <style>
      .tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 0 0 16px;
      }

      .tab-btn {
        border: 1px solid var(--line);
        background: rgba(16, 12, 10, 0.45);
        color: var(--text);
        border-radius: 999px;
        padding: 8px 14px;
        font-weight: 700;
        cursor: pointer;
      }

      .tab-btn.active {
        border-color: var(--gold);
        background: rgba(212, 166, 63, 0.16);
      }

      .group-card {
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 0;
        background: var(--card);
        overflow: hidden;
      }

      .group-title {
        margin: 0;
        font-size: 28px;
        font-family: Cinzel, Georgia, serif;
      }

      .group-desc {
        margin: 4px 0 14px;
        color: var(--muted);
      }

      .group-line {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 0;
        border-top: 1px solid var(--line);
      }

      .group-line:first-of-type {
        border-top: 0;
      }

      .line-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .group-toggle {
        cursor: pointer;
        list-style: none;
        padding: 16px 18px;
      }

      .group-toggle::-webkit-details-marker {
        display: none;
      }

      .group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
      }

      .group-arrow {
        font-size: 12px;
        color: var(--gold-soft);
        transform: rotate(0deg);
        transition: transform 0.2s ease;
      }

      details[open] .group-arrow {
        transform: rotate(180deg);
      }

      .group-content {
        padding: 0 18px 14px;
      }

      .box-compo {
        margin-top: 10px;
        border-top: 1px solid var(--line);
        padding-top: 10px;
      }

      .box-compo summary {
        cursor: pointer;
        color: var(--gold-soft);
        font-weight: 700;
      }

      .box-compo ul {
        margin: 8px 0 0;
        padding-left: 18px;
        color: var(--muted);
      }

      .box-compo li {
        margin: 4px 0;
      }
    </style>
  </head>
  <body>
    <main class="page">
      <header class="topbar">
        <a class="brand" href="./index.html">
          <img src="./_assets/v11/7d430060b52ad00caf731348e0b37642ca6bf1ea.png" alt="Logo Sawadika" />
          <div class="brand-name">Sawadika</div>
        </a>
        <nav class="nav" aria-label="Navigation principale">
          <a class="active" href="./menu.html">Menu</a>
          <a href="./reservation.html">Reserver</a>
          <a href="./panier.html">Panier <span class="cart-badge" id="cart-badge">0</span></a>
        </nav>
      </header>

      <h1 class="section-title">Le Menu</h1>
      <p class="section-subtitle">Un menu où tradition et modernité se rencontrent, préparé à la commande pour une fraîcheur optimale.</p>

      <section class="tabs" id="menu-tabs" aria-label="Categories du menu"></section>
      <section class="grid grid-3" id="menu-grid" aria-label="Liste des plats"></section>
    </main>

    <script>
      const fallbackMenu = [
        { id: "tha-1", category: "Thai Food", name: "Pad Thai crevettes", desc: "Nouilles de riz sautees, crevettes, soja, cacahuete.", price: 13.90 },
        { id: "tha-2", category: "Thai Food", name: "Curry vert poulet", desc: "Lait de coco, basilic thai, legumes de saison.", price: 14.50 },
        { id: "ind-1", category: "Indian Food", name: "Boeuf satay", desc: "Boeuf marine, sauce satay maison, riz parfume.", price: 15.00 },
        { id: "ind-2", category: "Indian Food", name: "Poulet croustillant", desc: "Sauce aigre douce, sesame, wok de legumes.", price: 13.50 },
        { id: "jap-1", category: "Jap Food", name: "Plateau sushi mix", desc: "12 pieces chef selection, gingembre et wasabi.", price: 16.90 },
        { id: "jap-2", category: "Jap Food", name: "Donburi saumon", desc: "Riz vinaigre, saumon, avocat, sauce maison.", price: 14.90 },
        { id: "ent-1", category: "Entree", name: "Nems poulet x4", desc: "Nems croustillants servis avec sauce nuoc mam.", price: 6.50 },
        { id: "des-1", category: "Dessert", name: "Mochis assortiment", desc: "Selection de mochis glaces du moment.", price: 5.90 }
      ];

      const cartKey = window.SAWADIKA_CART_KEY || "sawadika_cart";
      const menuItems = Array.isArray(window.SAWADIKA_MENU) && window.SAWADIKA_MENU.length
        ? window.SAWADIKA_MENU
        : fallbackMenu;
      const fallbackCategories = [
        "Entree",
        "Thai Food",
        "Indian Food",
        "Jap Food",
        "Sushi & Rolls",
        "Box",
        "Dessert",
        "Boissons"
      ];
      const configuredCategories = Array.isArray(window.SAWADIKA_CATEGORIES) && window.SAWADIKA_CATEGORIES.length
        ? window.SAWADIKA_CATEGORIES
        : fallbackCategories;
      const categories = configuredCategories;
      let currentCategory = categories[0] || "";

      function getCart() {
        try {
          return JSON.parse(localStorage.getItem(cartKey) || "[]");
        } catch {
          return [];
        }
      }

      function setCart(cart) {
        localStorage.setItem(cartKey, JSON.stringify(cart));
      }

      function getCartCount(cart) {
        return cart.reduce((sum, line) => sum + (line.qty || 0), 0);
      }

      function updateCartBadge() {
        const badge = document.getElementById("cart-badge");
        if (!badge) return;
        const count = getCartCount(getCart());
        badge.textContent = String(count);
        badge.classList.toggle("show", count > 0);
        badge.classList.remove("bump");
        if (count > 0) {
          requestAnimationFrame(() => badge.classList.add("bump"));
        }
      }

      function getQty(itemId) {
        const cart = getCart();
        const line = cart.find((x) => x.id === itemId);
        return line ? line.qty : 0;
      }

      function updateQtyDisplays(itemId, qty) {
        document.querySelectorAll(`[data-qty-for="${itemId}"]`).forEach((el) => {
          el.textContent = String(qty);
        });
      }

      function updateQuantity(itemId, delta, triggerButton) {
        const cart = getCart();
        const current = cart.find((x) => x.id === itemId);
        if (current) {
          current.qty += delta;
        } else if (delta > 0) {
          cart.push({ id: itemId, qty: 1 });
        }
        const cleaned = cart.filter((x) => x.qty > 0);
        const newQty = cleaned.find((x) => x.id === itemId)?.qty || 0;
        setCart(cleaned);
        updateCartBadge();
        updateQtyDisplays(itemId, newQty);
        if (triggerButton) {
          triggerButton.classList.remove("btn-anim");
          requestAnimationFrame(() => triggerButton.classList.add("btn-anim"));
        }
      }

      function renderTabs() {
        const tabsRoot = document.getElementById("menu-tabs");
        tabsRoot.innerHTML = "";
        categories.forEach((category) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = `tab-btn${category === currentCategory ? " active" : ""}`;
          btn.textContent = category;
          btn.addEventListener("click", () => {
            currentCategory = category;
            renderTabs();
            renderMenu();
          });
          tabsRoot.appendChild(btn);
        });
      }

      function renderMenu() {
        const root = document.getElementById("menu-grid");
        root.innerHTML = "";
        const visibleItems = menuItems.filter((item) => item.category === currentCategory);

        const hasSubgroups = visibleItems.some((item) => item.subgroup);
        root.className = hasSubgroups ? "grid" : "grid grid-3";

        if (hasSubgroups) {
          const groups = [...new Set(visibleItems.filter((x) => x.subgroup).map((x) => x.subgroup))];
          groups.forEach((groupName) => {
            const groupItems = visibleItems.filter((x) => x.subgroup === groupName);
            const card = document.createElement("details");
            card.className = "group-card";
            const groupDesc = groupItems[0]?.groupDesc || "";
            card.open = groups.length === 1;

            card.innerHTML = `
              <summary class="group-toggle">
                <div class="group-header">
                  <div>
                    <h2 class="group-title">${groupName}</h2>
                    <p class="group-desc">${groupDesc}</p>
                  </div>
                  <span class="group-arrow">▼</span>
                </div>
              </summary>
              <div class="group-content"></div>
            `;

            const content = card.querySelector(".group-content");

            groupItems.forEach((item) => {
              const row = document.createElement("div");
              row.className = "group-line";
              const qty = getQty(item.id);
              const lineDesc = item.desc ? `<div class="notice" style="margin:2px 0 0;">${item.desc}</div>` : "";
              row.innerHTML = `
                <div class="line-left" style="flex-direction:column;align-items:flex-start;">
                  <strong>${item.name}</strong>
                  ${lineDesc}
                </div>
                <div class="line-left">
                  <span class="price">${window.priceEUR(item.price)}</span>
                  <div class="qty-control">
                    <button class="qty-btn" type="button" data-action="minus" data-id="${item.id}">-</button>
                    <span class="qty-count" data-qty-for="${item.id}">${qty}</span>
                    <button class="qty-btn" type="button" data-action="plus" data-id="${item.id}">+</button>
                  </div>
                </div>
              `;
              content.appendChild(row);
            });

            root.appendChild(card);
          });
        } else {
          visibleItems.forEach((item) => {
            const card = document.createElement("article");
            card.className = "card";
            const compositionHtml = Array.isArray(item.composition) && item.composition.length
              ? `
                <details class="box-compo">
                  <summary>Voir composition</summary>
                  <ul>${item.composition.map((line) => `<li>${line}</li>`).join("")}</ul>
                </details>
              `
              : "";
            const qty = getQty(item.id);
            card.innerHTML = `
              <div class="badge">${item.category}</div>
              <h2 class="item-name">${item.name}</h2>
              <p class="item-desc">${item.desc}</p>
              <div class="item-footer">
                <span class="price">${window.priceEUR(item.price)}</span>
                <div class="qty-control">
                  <button class="qty-btn" type="button" data-action="minus" data-id="${item.id}">-</button>
                  <span class="qty-count" data-qty-for="${item.id}">${qty}</span>
                  <button class="qty-btn" type="button" data-action="plus" data-id="${item.id}">+</button>
                </div>
              </div>
              ${compositionHtml}
            `;
            root.appendChild(card);
          });
        }

        if (!root.dataset.bound) {
          root.addEventListener("click", (event) => {
            const btn = event.target.closest("button[data-action]");
            if (!btn) return;
            const id = btn.getAttribute("data-id");
            const action = btn.getAttribute("data-action");
            const delta = action === "plus" ? 1 : -1;
            updateQuantity(id, delta, btn);
          });
          root.dataset.bound = "1";
        }
      }

      renderTabs();
      renderMenu();
      updateCartBadge();
    </script>
  </body>
</html>
