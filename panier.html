<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Panier Sawadika : commande click and collect." />
    <title>Panier | Sawadika</title>
    <link rel="icon" href="./favicon.ico" sizes="any" />
    <link rel="icon" type="image/png" href="./favicon.png" />
    <link rel="stylesheet" href="./styles.css" />
    <script src="./data.js" defer></script>
  </head>
  <body>
    <main class="page">
      <header class="topbar">
        <a class="brand" href="./index.html">
          <img src="./_assets/v11/7d430060b52ad00caf731348e0b37642ca6bf1ea.png" alt="Logo Sawadika" />
          <div class="brand-name">Sawadika</div>
        </a>
        <nav class="nav" aria-label="Navigation principale">
          <a href="./menu.html">Menu</a>
          <a href="./reservation.html">Reserver</a>
          <a class="active" href="./panier.html">Panier</a>
        </nav>
      </header>

      <h1 class="section-title">Panier</h1>
      <p class="section-subtitle">Validez votre commande avec nom, telephone et heure de recuperation.</p>

      <section class="grid grid-2">
        <article class="card">
          <h2 class="item-name" style="margin-bottom: 10px">Votre commande</h2>
          <div id="cart-list"></div>
          <p class="total" id="cart-total">0,00 EUR</p>
          <div style="margin-top: 12px">
            <a class="btn btn-secondary" href="./menu.html">Ajouter des plats</a>
            <button class="btn btn-danger" type="button" id="clear-cart">Vider</button>
          </div>
        </article>

        <article class="card">
          <h2 class="item-name" style="margin-bottom: 10px">Infos client</h2>
          <form class="form" id="order-form">
            <div>
              <label for="customer-name">Nom</label>
              <input id="customer-name" name="customerName" required />
            </div>
            <div>
              <label for="customer-phone">Telephone</label>
              <input id="customer-phone" name="customerPhone" required />
            </div>
            <div>
              <label for="pickup-time">Heure de recuperation (min +20 min)</label>
              <input id="pickup-time" name="pickupTime" type="datetime-local" required />
            </div>
            <div>
              <label for="order-notes">Commentaire</label>
              <textarea id="order-notes" name="orderNotes" placeholder="Sans oignon, sauce a part, etc."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Envoyer la commande</button>
            <p class="notice">Destinataire: sawadika689@gmail.com</p>
          </form>
        </article>
      </section>
    </main>

    <script>
      const listEl = document.getElementById("cart-list");
      const totalEl = document.getElementById("cart-total");
      const clearBtn = document.getElementById("clear-cart");
      const form = document.getElementById("order-form");
      const pickupInput = document.getElementById("pickup-time");

      function getCart() {
        try {
          return JSON.parse(localStorage.getItem(window.SAWADIKA_CART_KEY) || "[]");
        } catch {
          return [];
        }
      }

      function setCart(cart) {
        localStorage.setItem(window.SAWADIKA_CART_KEY, JSON.stringify(cart));
      }

      function getItemById(id) {
        return window.SAWADIKA_MENU.find((x) => x.id === id);
      }

      function setMinPickup() {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 20);
        now.setSeconds(0, 0);
        pickupInput.min = now.toISOString().slice(0, 16);
      }

      function renderCart() {
        const cart = getCart();
        if (cart.length === 0) {
          listEl.innerHTML = '<p class="notice">Votre panier est vide.</p>';
          totalEl.textContent = "0,00 EUR";
          return;
        }

        let total = 0;
        listEl.innerHTML = "";

        cart.forEach((line) => {
          const item = getItemById(line.id);
          if (!item) return;
          const lineTotal = item.price * line.qty;
          total += lineTotal;

          const row = document.createElement("div");
          row.className = "cart-row";
          row.innerHTML = `
            <div>
              <div class="item-name" style="font-size:16px">${item.name}</div>
              <div class="notice">${window.priceEUR(item.price)} / unite</div>
            </div>
            <div class="qty">
              <button type="button" data-action="minus" data-id="${item.id}">-</button>
              <span>${line.qty}</span>
              <button type="button" data-action="plus" data-id="${item.id}">+</button>
            </div>
            <div class="price">${window.priceEUR(lineTotal)}</div>
          `;
          listEl.appendChild(row);
        });

        totalEl.textContent = window.priceEUR(total);
      }

      listEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;

        const action = btn.getAttribute("data-action");
        const id = btn.getAttribute("data-id");
        const cart = getCart();
        const line = cart.find((x) => x.id === id);
        if (!line) return;

        if (action === "plus") line.qty += 1;
        if (action === "minus") line.qty -= 1;

        const filtered = cart.filter((x) => x.qty > 0);
        setCart(filtered);
        renderCart();
      });

      clearBtn.addEventListener("click", () => {
        setCart([]);
        renderCart();
      });

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const cart = getCart();
        if (cart.length === 0) {
          alert("Le panier est vide.");
          return;
        }

        setMinPickup();
        if (pickupInput.value < pickupInput.min) {
          alert("L heure de recuperation doit etre au minimum dans 20 minutes.");
          return;
        }

        const fd = new FormData(form);
        let total = 0;
        const lines = cart
          .map((line) => {
            const item = getItemById(line.id);
            if (!item) return null;
            const lineTotal = item.price * line.qty;
            total += lineTotal;
            return `- ${item.name} x${line.qty} = ${window.priceEUR(lineTotal)}`;
          })
          .filter(Boolean)
          .join("\n");

        const subject = encodeURIComponent("Commande click and collect Sawadika");
        const body = encodeURIComponent(
          [
            "Nouvelle commande:",
            "",
            lines,
            "",
            `Total: ${window.priceEUR(total)}`,
            "",
            `Nom: ${fd.get("customerName")}`,
            `Telephone: ${fd.get("customerPhone")}`,
            `Recuperation: ${fd.get("pickupTime")}`,
            `Commentaire: ${fd.get("orderNotes") || "Aucun"}`
          ].join("\n")
        );

        window.location.href = `mailto:${window.SAWADIKA_EMAIL}?subject=${subject}&body=${body}`;
      });

      setMinPickup();
      renderCart();
    </script>
  </body>
</html>
